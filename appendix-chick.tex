\chapter{\Chick{}}~\label{appendix-chick}

\begin{Rules}{rules-lookup}{ Lookup rules (local context and global environment) }

\begin{mathpar}
  {
    \inferrule*
    [lab=\LookupCtxt]
    {\turnstile
      { \diff {\Gamma} {\delta_\Gamma} }
      { \declDiff { v } { \delta_v } { \delta_{\tau} } }
    }
    {\turnstile
      {\dcontext {E} {\delta_E} {\Gamma} {\delta_\Gamma} }
      { \declDiff { v } { \delta_v } { \delta_{\tau} } }
    }
  }

  {
    \inferrule*
    [lab=\LookupEnv]
    {
      {\turnstile
        { \diff {E} {\delta_E} }
        { \declDiff { v } { \delta_v } { \delta_{\tau} } }
      }
    }
    {\turnstile
      { \dcontext {E} {\delta_E} {\Gamma} {\delta_\Gamma} }
      { \declDiff { v } { \delta_v } { \delta_{\tau} } }
    }
  }

\end{mathpar}

\end{Rules}

\begin{Rules}{rules-lookup-context}{ Lookup in the local context }

  \begin{mathpar}
    {
      \inferrule*
      [lab=\LCSame]
      {
        { \turnstile {\Gamma} {\hasType { v } { \out{\tau_v} } } }
      }
      {\turnstile
        { \diff {\Gamma} {\MathSame} }
        { \declDiff { v } { \MathSame } { \MathSame } }
      }
    }

    {
      \inferrule*
      [lab=\LCIns]
      {\turnstile
        { \diff {\Gamma} {\delta_{\Gamma}} }
        { \declDiff { v } { \delta_v } { \delta_{\tau_v} } }
      }
      {\turnstile
        { \diff {\Gamma} {\MathIns{ \texttt{\_} }{\delta_{\Gamma}}} }
        { \declDiff { v } { \delta_v } { \delta_{\tau_v} } }
      }
    }

    % {
    % \inferrule*
    % [lab=\LCKeep]
    % {\turnstile
    % { \diff {\Gamma} {\MathMod{\MathSame}{\delta_{\Gamma}}} }
    % { \declDiff { v } { \delta_v } { \delta_{\tau_v} } }
    % }
    %   {\turnstile
    %   { \diff {\Gamma} {\MathKeep{\delta_{\Gamma}}} }
    %   { \declDiff { v } { \delta_v } { \delta_{\tau_v} } }
    % }
    % }

  \end{mathpar}

  \begin{mathpar}
    {
      \inferrule*
      [lab=\LCMod{$=$}]
      {
      }
      {\turnstile
        { \diff {\MathCons{\MathLocalAssum{v}{\tau}}{\Gamma}} {\MathMod{(\delta_v : \delta_{\tau})}{\delta_{\Gamma}}} }
        { \declDiff { v } { \delta_v } { \delta_{\tau} } }
      }
    }

    {
      \inferrule*
      [lab=\LCMod{$\neq$}]
      {
        v' \neq v
        \and
        {\turnstile
          { \diff {\Gamma} {\delta_{\Gamma}} }
          { \declDiff { v } { \delta_v } { \delta_{\tau} } }
        }
      }
      {\turnstile
        { \diff {\MathCons{\MathLocalAssum{v'}{\tau}}{\Gamma}} {\MathMod{(\delta_v : \delta_{\tau})}{\delta_{\Gamma}}} }
        { \declDiff { v } { \delta_v } { \delta_{\tau} } }
      }
    }

  \end{mathpar}

  % \begin{mathpar}
  %   {
  %     \inferrule*
  %     [lab=\LCMod{Def-$=$}]
  %     {
  %     }
  %     {\turnstile
  %       { \diff {\MathCons{\MathLocalDef{v}{\tau}{t}}{\Gamma}} {\MathMod{\MathLocalDef{\delta_v}{\delta_{\tau}}{\delta_t}}{\delta_{\Gamma}}} }
  %       { \declDiff { v } { \delta_v } { \delta_{\tau} } }
  %     }
  %   }

  %   {
  %     \inferrule*
  %     [lab=\LCMod{Def-$\neq$}]
  %     {
  %       v' \neq v
  %       \and
  %       {\turnstile
  %         {\diff{\Gamma}{\delta_{\Gamma}}}
  %         {\declDiff{v}{\delta_v}{\delta_{\tau}}}
  %       }
  %     }
  %     {\turnstile
  %       {\diff
  %         {\MathCons{\MathLocalDef{v'}{\tau}{t}}{\Gamma}}
  %         {\MathMod{\MathLocalDef{\delta_v}{\delta_{\tau}}{\delta_t}}{\delta_{\Gamma}}}
  %       }
  %       {\declDiff{v}{\delta_v}{\delta_{\tau}}}
  %     }
  %   }

  % \end{mathpar}

\end{Rules}

\begin{Rules}{rules-lookup-environment}{
    Lookup in the global environment
  }

  \begin{mathpar}
    {
      \inferrule*
      [lab=\GESame]
      {
        { \turnstile {E} {\hasType { v } { \out{\tau_v} } } }
      }
      {\turnstile
        { \diff {E} {\MathSame} }
        { \declDiff { v } { \MathSame } { \MathSame } }
      }
    }

    {
      \inferrule*
      [lab=\GEIns]
      {\turnstile
        { \diff {E} {\delta_{E}} }
        { \declDiff { v } { \delta_v } { \delta_{\tau_v} } }
      }
      {\turnstile
        { \diff {E} {\MathIns{ \texttt{\_} }{\delta_{E}}} }
        { \declDiff { v } { \delta_v } { \delta_{\tau_v} } }
      }
    }

    % {
    % \inferrule*
    % [lab=\GEKeep]
    % {\turnstile
    % { \diff{E}{\MathMod{\MathSame}{\delta_{E\,'}}} }
    % { \declDiff{v}{\delta_v}{\delta_{\tau_v}} }
    % }
    %   {\turnstile
    %   { \diff{E}{\MathKeep{\delta_{E\,'}}} }
    %   { \declDiff{v}{\delta_v}{\delta_{\tau_v}} }
    % }
    % }

    {
      \inferrule*
      [lab=\GEMod{Defn}]
      {
      }
      {\turnstile
        { \diff
          {\MathCons{\Definition{k}{v}{\tau}{t}}{E}}
          {\MathMod{\ModifyDefinition{\delta_k}{\delta_v}{\delta_\tau}{\delta_t}}{\delta_{E}}}
        }
        { \declDiff { v } { \delta_v } { \delta_{\tau} } }
      }
    }

    {
      \inferrule*
      [lab=\GEMod{Inductive}]
      {
        \deltaIndType
        {\overrightarrow{p}}
        {\delta_{\overrightarrow{p}}}
        {\overrightarrow{i}}
        {\delta_{\overrightarrow{i}}}
        {u}
        {\delta_u}
        {\delta_\tau}
      }
      {\turnstile
        { \diff
          {\MathCons
            {\Inductive
              {n}
              {\overrightarrow{p}}
              {\overrightarrow{i}}
              {u}
              {\overrightarrow{c}}
            }
            {E}
          }
          {\MathMod
            {\ModifyInductive
              {\delta_n}
              {\delta_{\overrightarrow{p}}}
              {\delta_{\overrightarrow{i}}}
              {\delta_u}
              {\delta_{\overrightarrow{c}}}
            }
            {\delta_{E}}
          }
        }
        { \declDiff{n}{\delta_n}{\delta_{\tau}} }
      }
    }

    % Possibilities:
    % (v + cs), (δv +mod δcs)
    % (v + cs), (-drop δcs)
    % (v + cs), (+keep δcs)
    % (v + cs), (permute p δcs)
    % (v + cs), (v' +ins δcs)
    % (v' + cs), (δv +mod δcs)
    % (v' + cs), (-drop δcs)
    % (v' + cs), (+keep δcs)
    % (v' + cs), (permute p δcs)
    % (v' + cs), (v'' +ins δcs)
    {
      \inferrule*
      [lab=\GEMod{Constructor}]
      {
        \deltaConstructor
        {\overrightarrow{p}}
        {\delta_{\overrightarrow{p}}}
        {\overrightarrow{i}}
        {\delta_{\overrightarrow{i}}}
        {\overrightarrow{c}}
        {\delta_{\overrightarrow{c}}}
        {v}
        {(\delta_v, \delta_\tau)}
      }
      {\turnstile
        { \diff
          {\MathCons
            {\Inductive
              {n}
              {\overrightarrow{p}}
              {\overrightarrow{i}}
              {u}
              {\overrightarrow{c}}
            }
            {E}
          }
          {\MathMod
            {\ModifyInductive
              {\delta_n}
              {\delta_{\overrightarrow{p}}}
              {\delta_{\overrightarrow{i}}}
              {\delta_u}
              {\delta_{\overrightarrow{c}}}
            }
            {\delta_{E}}
          }
        }
        { \declDiff{v}{\delta_v}{\delta_{\tau}} }
      }
    }

    {
      \inferrule*
      [lab=\GEMod{Eliminator}]
      {
        \deltaEliminator
        {\diff{n}{\delta_n}}
        {\diff{\overrightarrow{p}}{\delta_{\overrightarrow{p}}}}
        {\diff{\overrightarrow{i}}{\delta_{\overrightarrow{i}}}}
        {\diff{\overrightarrow{c}}{\delta_{\overrightarrow{c}}}}
        {v}
        {(\delta_v, \delta_\tau)}
      }
      {\turnstile
        { \diff
          {\MathCons
            {\Inductive
              {n}
              {\overrightarrow{p}}
              {\overrightarrow{i}}
              {u}
              {\overrightarrow{c}}
            }
            {E}
          }
          {\MathMod
            {\ModifyInductive
              {\delta_n}
              {\delta_{\overrightarrow{p}}}
              {\delta_{\overrightarrow{i}}}
              {\delta_u}
              {\delta_{\overrightarrow{c}}}
            }
            {\delta_{E}}
          }
        }
        { \declDiff{v}{\delta_v}{\delta_{\tau}} }
      }
    }

    {
      \inferrule*
      [lab=\GEMod{Otherwise}]
      {\turnstile
        {\diff{E}{\delta_{E}}}
        {\declDiff{v}{\delta_v}{\delta_{\tau}}}
      }
      {\turnstile
        {\diff
          {\MathCons{d}{E}}
          {\MathMod{\delta_d}{\delta_{E}}}
        }
        {\declDiff{v}{\delta_v}{\delta_{\tau}}}
      }
    }

  \end{mathpar}

\end{Rules}
