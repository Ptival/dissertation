\section{Evaluation}

We built a tool, called \PeaCoq{}, to try and evaluate the usefulness of those
techniques in a beginner setting.  We conducted two studies: a longitudinal
study in the classroom during one quarter, and a short A-B study with beginners.

\subsection{Longitudinal study}~\label{peacoq-longitudinal-study}

The first study was conducted at the University of Washington, with the help of
instructor Zachary Tatlock, during the Winter quarter of 2015.

The study was approved by the institutional review board of the University of
California, San Diego (project~\#141713), and the institutional review board of
the University of Washington (project~\#48738).

Every student in the class was given the option to use \PeaCoq{} instead of
other IDEs for working on their homework.  At any moment, they could opt in and
out of using \PeaCoq{} with no overhead.  This study helped us iron out details
on the automation and the display, based on students' feedback.

% TODO: find UW PeaCoq notes and write it up

\subsection{A-B study}~\label{peacoq-a-b-study}

Participants in the A-B study were volunteers who received no financial
compensation, but were offered free slices of pizza, a highly sought treat in
academic settings.

\paragraph{Study setup}

The study was done in two instances, totaling 20 participants.  For each
instance of the study, 10 participants were chosen randomly but based on their
availability, then participants were randomly paired in 5 groups.  Both groups
were informed that they would be testing a novel programming environment.

The 5 groups in the \define{control group} were provided with an instance of
\PeaCoq{} designed to imitate the usual IDEs for \Coq{}: all the special
features of \PeaCoq{} were disabled, except for its syntax highlighting, and
keyboard shortcuts.

The 5 groups in the \define{study group} were provided with an instance of
\PeaCoq{} with the proof tree view always enabled, visual diffs overlaid on top
of nodes in the proof tree view, and automation running in the background to
populate the proof tree view with candidate tactics, all enabled.

Neither group was informed about the fact that this was an A-B study, or about
whether they were testing the real prototype or the control version.  Both
instances were structured identically: the first hour was a general presentation
of the tool they would use, and of basics of the \Coq{} proof assistant.  Then,
each pair of participant was tasked with solving 16 problems of increasing
difficulty, testing their understanding of what they have seen so far, as well
as their ability to learn about new proof solving tactics and use them
effectively.  The second part was scheduled to take up to an hour and a half.

After the study was over, and before they left, the participants were handed an
anonymous questionnaire, asking them about some qualitative feedback and
information about their education level.

\paragraph{Study material}

During the first part of the study, participants were introduced, by the study
coordinator, to the following concepts:

\begin{itemize}

\item an \emph{inductive datatype definition} \coqinline{day}, with constructors
\coqinline{monday}, \coqinline{tuesday}, etc.,

\item a \emph{function definition} \coqinline{tomorrow}, defined by
pattern-matching,

\item a theorem asserting that \coqinline{tomorrow saturday = sunday}, proven
introducing the tactics \coqinline{simpl} and \coqinline{reflexivity},

\item a recursive data type, \coqinline{natlist}, representing a monomorphic
list of natural numbers,

\item a \emph{recursive} function, \coqinline{concat}, performing list
concatenation,

\item another theorem about the concatenation of two concrete lists, displaying
an instance of associativity, and proven using the same tactics seen so far,

\item a theorem asserting that \coqinline{nil} is a left-unit for
\coqinline{concat}, proven with the previous tactics, with the addition of the
\coqinline{intros} tactic to introduce the universally-quantified list
\coqinline{l},

\item a theorem asserting that \coqinline{nil} is a right-unit for
\coqinline{concat}, proven by introducing the \coqinline{induction} tactic, and
also introducing the first \coqinline{rewrite},

\item a theorem asserting the associativity of the \coqinline{concat} operation,
proven by using \coqinline{induction}, and the other tactics mentioned so far.

\end{itemize}

During the second part of the study, they had to try and solve all 16 exercises,
as listed exhaustively in Appendix~\ref{appendix-peacoq-material}.  The
exercises can be roughly described as follows:

\begin{enumerate}

  \item \coqinline{rev_snoc}: After introducing a recursive function
\coqinline{snoc} to append one element to the end of a list, and a recursive
function \coqinline{rev} to reverse a list, participants were asked to
demonstrate that a sequence of \coqinline{rev} after \coqinline{snoc} is
equivalent to a sequence of \coqinline{cons} after \coqinline{rev}.

  \item \coqinline{rev_involutive}: Participants were asked to demonstrate that
\coqinline{rev} is involutive (i.e.\ applying it twice consecutively yields the
original input).

  \item \coqinline{concat_cons_snoc}: Participants were asked to prove an
equality about the interplay of \coqinline{concat} and \coqinline{snoc}.

  \item \coqinline{go_somewhere}: A new concept was introduced: disjunction.
Two tactics to manipulate this concept were introduced: \coqinline{left} and
\coqinline{right}.  An example was given of proving the disjunction of a
falsehood on the left, and a tautology on the right.  Participants were then
asked to find the only disjunct that was a tautology within a nested disjunction
of falsehoods.  Finding the only tautology required uses of both
\coqinline{left} and \coqinline{right}.

  \item \coqinline{B_is_enough}: Participants were introduced to the tactic
\coqinline{apply}, and asked to prove a disjunction where one disjunct was given
in the premises, and one was not.

  \item \coqinline{more_facts}: Participants were introduced to the concept of
conjunction.  A new tactic, \coqinline{split}, was then introduced to prove
conjunctions.  They were then asked to prove the conjunction of two tautologies.

  \item \coqinline{A_and_B}: To re-assert the importance of \coqinline{apply},
participants were asked to prove a conjunction where each conjunct was found in
the premises.

  \item \coqinline{snoc_concat_end}: Two harder exercises about list were then
presented.  The first one, asking about a more complex interplay between
\coqinline{concat} and \coqinline{snoc},

  \item \coqinline{rev_distributes_over_concat}: the second one, asking to prove
that \coqinline{rev} distributes over \coqinline{concat}.

  \item \coqinline{map_commutes}: Participants were introduced to the concept of
the function \coqinline{map} over lists.  They then showed that, if two
functions commute, then mapping these two functions also commutes.

  \item \coqinline{map_fusion}: Participants were asked to prove the map fusion
property.

  \item \coqinline{fold_snoc}: Participants were introduced to the concept of a
\coqinline{fold} over a list.  They then demonstrated an interplay between
\coqinline{fold} and \coqinline{snoc}.

  \item \coqinline{map'_unroll}: Participants were asked to demonstrate that
performing the operation \coqinline{map} over a list obtained via
\coqinline{cons} can be unrolled one step.

  \item \coqinline{map_map'}: Participants were then shown how \coqinline{map}
can be implemented as a \coqinline{fold}.  The resulting implementation, named
\coqinline{map'}, was then demonstrated to be functionally equivalent to
\coqinline{map}.  To help them, we axiomatized a small theorem that they could
use without needing to prove.

  \item \coqinline{In_cons}: We introduced a recursive predicate,
\coqinline{In}, asserting the presence of an element in a list.  They were first
asked to prove that if an element is in a list, it is still present in a list
with an additional element.

  \item \coqinline{In_concat_left}: Two final concepts were introduced: the
\coqinline{cases} tactic is a custom tactic that let participants break a
conjunction in their context into its components, and the
\coqinline{contradiction} tactic allowing them to point to the presence of
falsehoods in the context.  Participants were finally asked to prove that if an
element belongs in a list, it also belongs in the result of concatenating said
list with an arbitrary other list.

\end{enumerate}

Table~\ref{peacoq-a-b-study-tactics} lists, for each of the exercises, which
tactics were meant to be exercised.  The exercises were roughly sorted in order
of difficulty, say for two points: the part introducing logical operators was
much simpler, and \coqinline{rev_distributes_over_concat} was a challenging
mid-point exercise.

\begin{table}[!htbp]
  \centering
  \caption{\PeaCoq{} A-B study exercises design}~\label{peacoq-a-b-study-tactics}
  \begin{tabular}{l *{11}{c}}
    \toprule
    Exercise & \multicolumn{11}{c}{What tactics were expected?} \\
    & \rotatebox{90}{\safecoqinline{simpl}}
    & \rotatebox{90}{\safecoqinline{reflexivity}}
    & \rotatebox{90}{\safecoqinline{intros}}
    & \rotatebox{90}{\safecoqinline{induction}}
    & \rotatebox{90}{\safecoqinline{rewrite}}
    & \rotatebox{90}{\safecoqinline{left}}
    & \rotatebox{90}{\safecoqinline{right}}
    & \rotatebox{90}{\safecoqinline{apply}}
    & \rotatebox{90}{\safecoqinline{split}}
    & \rotatebox{90}{\safecoqinline{cases}}
    & \rotatebox{90}{\safecoqinline{contradiction}}
    \\
%                                                Sim Rfx Int Ind Rwt Lft Rgt App Spt Cas Con
    \midrule
    01. \safecoqinline{rev_snoc        }      &\OK&\OK&\OK&\OK&\OK&   &   &   &   &   &   \\
    02. \safecoqinline{rev_involutive  }      &\OK&\OK&\OK&\OK&\OK&   &   &   &   &   &   \\
    03. \safecoqinline{concat_cons_snoc}      &\OK&\OK&\OK&\OK&\OK&   &   &   &   &   &   \\
    04. \safecoqinline{go_somewhere    }      &   &\OK&   &   &   &   &\OK&   &   &   &   \\
    05. \safecoqinline{B_is_enough     }      &   &\OK&   &   &   &\OK&\OK&   &   &   &   \\
    06. \safecoqinline{more_facts      }      &   &\OK&   &   &   &   &\OK&   &\OK&   &   \\
    07. \safecoqinline{A_and_B         }      &   &   &\OK&   &   &   &   &\OK&\OK&   &   \\
    08. \safecoqinline{snoc_concat_end }      &   &\OK&\OK&   &\OK&   &   &   &   &   &   \\
    09. \safecoqinline{rev_distributes}\ldots &\OK&\OK&\OK&\OK&\OK&   &   &   &   &   &   \\
    10. \safecoqinline{map_commutes    }      &\OK&\OK&\OK&\OK&\OK&   &   &   &   &   &   \\
    11. \safecoqinline{map_fusion      }      &\OK&\OK&\OK&\OK&\OK&   &   &   &   &   &   \\
    12. \safecoqinline{fold_snoc       }      &\OK&\OK&\OK&\OK&\OK&   &   &   &   &   &   \\
    13. \safecoqinline{map'_unroll     }      &   &\OK&\OK&   &   &   &   &   &   &   &   \\
    14. \safecoqinline{map_map'        }      &\OK&\OK&\OK&\OK&\OK&   &   &   &   &   &   \\
    15. \safecoqinline{In_cons         }      &\OK&   &\OK&   &   &   &\OK&\OK&   &   &   \\
    16. \safecoqinline{In_concat_left  }      &\OK&   &\OK&\OK&   &\OK&\OK&\OK&   &\OK&\OK\\
    \bottomrule
  \end{tabular}{\parfillskip=0pt\par}
\end{table}

\paragraph{Study results}

Table~\ref{peacoq-a-b-study-timings} lists the average timings of both groups on
each exercise, as well as a rough estimate of the difficulty of each exercise.
Figure~\ref{peacoq-a-b-study-cumulative} reports the cumulative time spent on
each exercise.  Note that users were allowed to take breaks between exercises,
and we do not report the time spent on the last exercises for those people who
did not finish all exercises: this explains why all bars do not end at the same
location.

\PeaCoq{} users were much slower on the first exercise.  Even though it was an
easy exercise, the automation offered several possibilities, which could have
been overwhelming: we noticed several participants spent a long time
scrutinizing different options before committing to one.  In the control group,
participants were left to their own volition, and followed the previous proofs
as examples.  Since the exercise exhibited the same pattern, it was a good
strategy.

\PeaCoq{} users were going much faster on the logic exercises
(\coqinline{go_somewhere} through \coqinline{A_and_B}).  For these, \PeaCoq{}
only provided a handful of options that were easily browsed through, so
participants of group B did not waste much time.

\input{table-peacoq-a-b-study-timings}

\input{figure-peacoq-a-b-TODO}

All the answers provided by participants to the post-study survey are
anonymously catalogued in Appendix~\ref{appendix-peacoq-a-b-study}.

\paragraph{Threats to validity}

We provide a list of the many threats to validity of our results, in no
particular order:

\begin{itemize}

  \item The sample size was very small (20 participants total, 10 per instance).
Unfortunately, the groups also had a very high variance, as can be seen by
looking at the standard deviations.  Often times, skilled groups finished
exercises extremely fast, while struggling groups spent very long amounts of
time stuck.

  \item The sample was biased towards graduate students, with only 3
undergraduate students (1 in the A group, 2 in the B group).

  \item The study was fast-paced, with only one hour to learn the rudiments of
theorem proving, and an hour and a half to solve exercises.  A typical
\emph{graduate} programming language course would most likely cover the topics
we saw in three to five lectures.

  \item A bug in \PeaCoq{} slowed down some pairs in group B: they had to wait
for us to come fix it, and reload the page to go back to where they initially
were.

  \item Participant $B4_{2}$ vocally explained their dislike for mathematical
logic.  This can be seen reflected in Appendix~\ref{appendix-peacoq}, where
their ratings were significantly lower than everyone else's.  We might expect better ratings from users who are willingly trying to learn, but we should also expect similar ratings from users who are forced to learn, for instance in a course setting.

\end{itemize}
